<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap AMM Demo - x*y=k</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #ff6b9d;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat-label {
            color: #888;
        }
        .stat-value {
            color: #fff;
            font-family: monospace;
            font-size: 1.1em;
        }
        .highlight {
            color: #ff6b9d !important;
            font-weight: bold;
        }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        input:focus {
            outline: none;
            border-color: #4ecdc4;
        }
        button {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,107,157,0.4);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4 0%, #2d9a94 100%);
        }
        .btn-secondary:hover {
            box-shadow: 0 5px 20px rgba(78,205,196,0.4);
        }
        .result {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            word-break: break-all;
        }
        .success { color: #4ecdc4; }
        .error { color: #ff6b6b; }
        .pool-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        .token-box {
            text-align: center;
            padding: 15px 25px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            min-width: 120px;
        }
        .token-name {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 5px;
        }
        .token-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
        }
        .multiply {
            font-size: 2em;
            color: #ff6b9d;
        }
        .equals {
            font-size: 1.5em;
            color: #888;
        }
        .k-value {
            font-size: 1.2em;
            color: #ff6b9d;
            font-weight: bold;
        }
        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .connected { background: #2d9a94; }
        .disconnected { background: #c44569; }
        .tx-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .tx-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 0.85em;
        }
        .tx-hash {
            color: #4ecdc4;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Uniswap AMM Demo</h1>
        <p class="subtitle">x * y = k 恒定乘积做市商算法</p>

        <div id="status" class="disconnected">Disconnected</div>

        <!-- Pool Visualization -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>Pool State (x * y = k)</h2>
            <div class="pool-visual">
                <div class="token-box">
                    <div class="token-name">Token0 (x)</div>
                    <div class="token-amount" id="viz-reserve0">-</div>
                </div>
                <div class="multiply">×</div>
                <div class="token-box">
                    <div class="token-name">Token1 (y)</div>
                    <div class="token-amount" id="viz-reserve1">-</div>
                </div>
                <div class="equals">=</div>
                <div class="token-box">
                    <div class="token-name">K</div>
                    <div class="k-value" id="viz-k">-</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Contract Info -->
            <div class="card">
                <h2>Contract Info</h2>
                <div class="stat">
                    <span class="stat-label">Contract Address</span>
                    <span class="stat-value" id="contract-address">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Reserve0</span>
                    <span class="stat-value" id="reserve0">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Reserve1</span>
                    <span class="stat-value" id="reserve1">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">K Value</span>
                    <span class="stat-value highlight" id="k-value">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Price (Token0 in Token1)</span>
                    <span class="stat-value" id="price0">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total LP Supply</span>
                    <span class="stat-value" id="total-supply">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Fee</span>
                    <span class="stat-value" id="fee">0.3%</span>
                </div>
                <button onclick="refreshData()" class="btn-secondary" style="margin-top: 15px;">
                    Refresh Data
                </button>
            </div>

            <!-- Swap -->
            <div class="card">
                <h2>Swap Tokens</h2>
                <div>
                    <label>Amount In:</label>
                    <input type="number" id="swap-amount" placeholder="e.g. 100" step="0.01">
                </div>
                <div style="margin: 15px 0;">
                    <label>
                        <input type="radio" name="swap-direction" value="0to1" checked>
                        Token0 → Token1
                    </label>
                    <label style="margin-left: 20px;">
                        <input type="radio" name="swap-direction" value="1to0">
                        Token1 → Token0
                    </label>
                </div>
                <button onclick="getQuote()" class="btn-secondary">Get Quote</button>
                <div class="result" id="swap-quote"></div>
                <button onclick="executeSwap()">Execute Swap</button>
                <div class="result" id="swap-result"></div>
            </div>

            <!-- Add Liquidity -->
            <div class="card">
                <h2>Add Liquidity</h2>
                <div>
                    <label>Amount Token0:</label>
                    <input type="number" id="add-amount0" placeholder="e.g. 100" step="0.01" oninput="calculateQuote()">
                </div>
                <div>
                    <label>Required Token1 (auto-calculated):</label>
                    <input type="number" id="add-amount1" placeholder="Will be calculated" readonly>
                </div>
                <button onclick="addLiquidity()">Add Liquidity</button>
                <div class="result" id="add-result"></div>
            </div>

            <!-- Remove Liquidity -->
            <div class="card">
                <h2>Remove Liquidity</h2>
                <div>
                    <label>Your LP Balance:</label>
                    <input type="text" id="user-lp" readonly>
                </div>
                <div>
                    <label>LP Amount to Remove:</label>
                    <input type="number" id="remove-amount" placeholder="e.g. 100" step="0.01">
                </div>
                <button onclick="removeLiquidity()">Remove Liquidity</button>
                <div class="result" id="remove-result"></div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <h2>Recent Transactions</h2>
                <div class="tx-list" id="tx-list">
                    <div class="tx-item" style="color: #888;">No transactions yet</div>
                </div>
            </div>

            <!-- Account Info -->
            <div class="card">
                <h2>Account</h2>
                <div class="stat">
                    <span class="stat-label">Address</span>
                    <span class="stat-value" id="user-address">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">ETH Balance</span>
                    <span class="stat-value" id="eth-balance">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">LP Token Balance</span>
                    <span class="stat-value" id="lp-balance">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const RPC_URL = "http://127.0.0.1:8545";

        // Anvil default test account
        const PRIVATE_KEY = "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";

        const ABI = [
            "function getReserve0() view returns (uint256)",
            "function getReserve1() view returns (uint256)",
            "function getK() view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address owner) view returns (uint256)",
            "function getPrice0(uint256 scale) view returns (uint256)",
            "function getPrice1(uint256 scale) view returns (uint256)",
            "function quote(uint256 amount0) view returns (uint256)",
            "function getAmountOut0To1(uint256 amount_in) view returns (uint256)",
            "function getAmountOut1To0(uint256 amount_in) view returns (uint256)",
            "function swap0For1(uint256 amount0_in) returns (uint256)",
            "function swap1For0(uint256 amount1_in) returns (uint256)",
            "function addLiquidity(uint256 amount0, uint256 amount1, address to) returns (uint256)",
            "function removeLiquidity(uint256 liquidity, address from) returns (uint256)",
            "function setFee(uint256 fee_num, uint256 fee_denom)",
            "function setReserves(uint256 r0, uint256 r1)",
            "function mintLP(address to, uint256 amount)"
        ];

        let provider, wallet, contract;
        const transactions = [];

        async function init() {
            try {
                provider = new ethers.JsonRpcProvider(RPC_URL);
                wallet = new ethers.Wallet(PRIVATE_KEY, provider);
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, wallet);

                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').className = 'connected';
                document.getElementById('contract-address').textContent = CONTRACT_ADDRESS.slice(0, 10) + '...' + CONTRACT_ADDRESS.slice(-8);
                document.getElementById('user-address').textContent = wallet.address.slice(0, 10) + '...' + wallet.address.slice(-8);

                await refreshData();

                // Auto refresh every 5 seconds
                setInterval(refreshData, 5000);
            } catch (e) {
                console.error(e);
                document.getElementById('status').textContent = 'Error: ' + e.message;
            }
        }

        function formatTokens(wei) {
            const num = parseFloat(ethers.formatEther(wei));
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(4);
        }

        function formatK(k) {
            const num = parseFloat(ethers.formatEther(k));
            const exp = Math.floor(Math.log10(num));
            return (num / Math.pow(10, exp)).toFixed(2) + 'e' + exp;
        }

        async function refreshData() {
            try {
                const [reserve0, reserve1, k, totalSupply, price0, lpBalance, ethBalance] = await Promise.all([
                    contract.getReserve0(),
                    contract.getReserve1(),
                    contract.getK(),
                    contract.totalSupply(),
                    contract.getPrice0(ethers.parseEther("1")),
                    contract.balanceOf(wallet.address),
                    provider.getBalance(wallet.address)
                ]);

                document.getElementById('reserve0').textContent = formatTokens(reserve0);
                document.getElementById('reserve1').textContent = formatTokens(reserve1);
                document.getElementById('k-value').textContent = formatK(k);
                document.getElementById('total-supply').textContent = formatTokens(totalSupply);
                document.getElementById('price0').textContent = formatTokens(price0);
                document.getElementById('lp-balance').textContent = formatTokens(lpBalance);
                document.getElementById('user-lp').value = formatTokens(lpBalance);
                document.getElementById('eth-balance').textContent = formatTokens(ethBalance) + ' ETH';

                // Update visualization
                document.getElementById('viz-reserve0').textContent = formatTokens(reserve0);
                document.getElementById('viz-reserve1').textContent = formatTokens(reserve1);
                document.getElementById('viz-k').textContent = formatK(k);

            } catch (e) {
                console.error('Refresh error:', e);
            }
        }

        async function getQuote() {
            try {
                const amount = document.getElementById('swap-amount').value;
                if (!amount) return;

                const amountWei = ethers.parseEther(amount);
                const direction = document.querySelector('input[name="swap-direction"]:checked').value;

                let amountOut;
                if (direction === '0to1') {
                    amountOut = await contract.getAmountOut0To1(amountWei);
                } else {
                    amountOut = await contract.getAmountOut1To0(amountWei);
                }

                document.getElementById('swap-quote').innerHTML =
                    `<span class="success">Expected output: ${formatTokens(amountOut)} tokens</span>`;
            } catch (e) {
                document.getElementById('swap-quote').innerHTML =
                    `<span class="error">Error: ${e.message}</span>`;
            }
        }

        async function executeSwap() {
            try {
                const amount = document.getElementById('swap-amount').value;
                if (!amount) return;

                const amountWei = ethers.parseEther(amount);
                const direction = document.querySelector('input[name="swap-direction"]:checked').value;

                document.getElementById('swap-result').innerHTML = '<span>Processing...</span>';

                let tx;
                if (direction === '0to1') {
                    tx = await contract.swap0For1(amountWei);
                } else {
                    tx = await contract.swap1For0(amountWei);
                }

                const receipt = await tx.wait();

                addTransaction('Swap', tx.hash, direction === '0to1' ? `${amount} T0 → T1` : `${amount} T1 → T0`);

                document.getElementById('swap-result').innerHTML =
                    `<span class="success">Success! TX: ${tx.hash.slice(0, 20)}...</span>`;

                await refreshData();
            } catch (e) {
                document.getElementById('swap-result').innerHTML =
                    `<span class="error">Error: ${e.message}</span>`;
            }
        }

        async function calculateQuote() {
            try {
                const amount0 = document.getElementById('add-amount0').value;
                if (!amount0) {
                    document.getElementById('add-amount1').value = '';
                    return;
                }

                const amount0Wei = ethers.parseEther(amount0);
                const amount1Wei = await contract.quote(amount0Wei);
                document.getElementById('add-amount1').value = formatTokens(amount1Wei);
            } catch (e) {
                document.getElementById('add-amount1').value = 'Error';
            }
        }

        async function addLiquidity() {
            try {
                const amount0 = document.getElementById('add-amount0').value;
                if (!amount0) return;

                const amount0Wei = ethers.parseEther(amount0);
                const amount1Wei = await contract.quote(amount0Wei);

                document.getElementById('add-result').innerHTML = '<span>Processing...</span>';

                const tx = await contract.addLiquidity(amount0Wei, amount1Wei, wallet.address);
                await tx.wait();

                addTransaction('Add Liquidity', tx.hash, `${amount0} T0 + T1`);

                document.getElementById('add-result').innerHTML =
                    `<span class="success">Success! TX: ${tx.hash.slice(0, 20)}...</span>`;

                await refreshData();
            } catch (e) {
                document.getElementById('add-result').innerHTML =
                    `<span class="error">Error: ${e.message}</span>`;
            }
        }

        async function removeLiquidity() {
            try {
                const amount = document.getElementById('remove-amount').value;
                if (!amount) return;

                const amountWei = ethers.parseEther(amount);

                document.getElementById('remove-result').innerHTML = '<span>Processing...</span>';

                const tx = await contract.removeLiquidity(amountWei, wallet.address);
                await tx.wait();

                addTransaction('Remove Liquidity', tx.hash, `${amount} LP`);

                document.getElementById('remove-result').innerHTML =
                    `<span class="success">Success! TX: ${tx.hash.slice(0, 20)}...</span>`;

                await refreshData();
            } catch (e) {
                document.getElementById('remove-result').innerHTML =
                    `<span class="error">Error: ${e.message}</span>`;
            }
        }

        function addTransaction(type, hash, details) {
            transactions.unshift({ type, hash, details, time: new Date().toLocaleTimeString() });
            if (transactions.length > 10) transactions.pop();

            const txList = document.getElementById('tx-list');
            txList.innerHTML = transactions.map(tx => `
                <div class="tx-item">
                    <strong>${tx.type}</strong> - ${tx.details}<br>
                    <span class="tx-hash">${tx.hash.slice(0, 30)}...</span><br>
                    <small>${tx.time}</small>
                </div>
            `).join('');
        }

        // Initialize on page load
        window.onload = init;
    </script>
</body>
</html>
